let kafalar = [];
let width = window.innerWidth;
let height = window.innerHeight;

document.getElementById('artı-btn').addEventListener('click', () => {
  if (kafalar.length === 0) {
    // Başlangıçta yalnızca bir kafa ekleyelim
    kafalar.push(new Kafa());
  }
});

function Kafa() {
  this.x = Math.random() * width;
  this.y = Math.random() * height / 2;
  this.vx = (Math.random() - 0.5) * 10;
  this.vy = Math.random() * 10 - 5;
  this.size = 80 + Math.random() * 40;
  this.angle = 0;
  this.angleSpeed = (Math.random() - 0.5) * 0.1; // Başlangıçta hafif dönüş
  this.dragging = false;
  this.offsetX = 0;
  this.offsetY = 0;
  this.stopped = false;
  this.hitboxRadius = this.size / 3; // Hitbox'ı küçük tutuyoruz
}

Kafa.prototype.update = function () {
  if (!this.dragging && !this.stopped) {
    this.x += this.vx;
    this.y += this.vy;
    this.vy += 0.5; // yerçekimi

    this.vx *= 0.985;
    this.vy *= 0.985;

    // Yere temas etme (hitbox ile)
    if (this.y + this.size > height) {
      this.y = height - this.size;
      if (Math.abs(this.vy) < 1.5) {
        this.vy = 0;
        this.vx *= 0.95;
        if (Math.abs(this.vx) < 0.2) {
          this.vx = 0;
          this.stopped = true;
        }
      } else {
        this.vy *= -0.55;
      }
    }

    if (this.x < 0) {
      this.x = 0;
      this.vx *= -0.8;
    } else if (this.x + this.size > width) {
      this.x = width - this.size;
      this.vx *= -0.8;
    }
  }

  // Kafanın dönmesi
  this.angle += this.angleSpeed;
};

// Çarpışma işlemi
function handleCollisions() {
  const bounce = 0.7;

  for (let i = 0; i < kafalar.length; i++) {
    for (let j = i + 1; j < kafalar.length; j++) {
      const a = kafalar[i];
      const b = kafalar[j];
      const dx = b.x - a.x;
      const dy = b.y - a.y;
      const dist = Math.hypot(dx, dy);
      const minDist = (a.hitboxRadius + b.hitboxRadius);

      if (dist < minDist) {
        const overlap = minDist - dist;
        const nx = dx / dist;
        const ny = dy / dist;

        a.x -= nx * overlap / 2;
        a.y -= ny * overlap / 2;
        b.x += nx * overlap / 2;
        b.y += ny * overlap / 2;

        const p = 2 * (a.vx * nx + a.vy * ny - b.vx * nx - b.vy * ny) / 2;

        a.vx -= bounce * p * nx;
        a.vy -= bounce * p * ny;
        b.vx += bounce * p * nx;
        b.vy += bounce * p * ny;

        // Dönme hızlarını güncelle
        const angleFactor = 0.05;
        a.angleSpeed += (p * angleFactor);
        b.angleSpeed += (p * angleFactor);
      }
    }
  }
}

// Animasyon ve çizim işlemleri
function animate() {
  ctx.clearRect(0, 0, width, height);
  
  handleCollisions();

  kafalar.forEach(kafa => {
    kafa.update();
    ctx.save();
    ctx.translate(kafa.x + kafa.size / 2, kafa.y + kafa.size / 2);
    ctx.rotate(kafa.angle);
    ctx.drawImage(kafaImage, -kafa.size / 2, -kafa.size / 2, kafa.size, kafa.size);
    ctx.restore();
  });

  requestAnimationFrame(animate);
}

// Başlangıçta bir kafa ekleyelim
kafalar.push(new Kafa());

let canvas = document.createElement("canvas");
document.body.appendChild(canvas);
let ctx = canvas.getContext("2d");

canvas.width = width;
canvas.height = height;

let kafalarImage = new Image();
kafalarImage.src = 'kafa.png'; // Kafanın görseli

kafalarImage.onload = function() {
  animate();
};
